<!DOCTYPE html>
<html>
    <head>
        <title>Polychart Test</title>
        <link rel="stylesheet" href="bootstrap.2.0.2/css/bootstrap.min.css" type="text/css" media="screen" />
        <script src="js/polychart.standalone.0.0.2.min.js"></script>
        <script src="js/jquery-1.7.2.min.js"></script>
        
        <script src="bootstrap.2.0.2/js/bootstrap-tab.js"></script>
    </head>
    <body>
        <div id="graphs" class="tabbale">
            <ul id="tabs" class="nav nav-tabs"></ul>
            <div id="content" class="tab-content"></div>
        </div>
        <script type="text/javascript">
            /* Assumes that you have run:
             curl -X POST -d "url=http://formhub.org/education/forms/schooling_status_format_18Nov11/data.csv" http://localhost:8080/collections
             */
        $(function(){
          var jsonUrl = '/calculate?id=5cf38a967da09c21bb754d091212a8ddc5638889',//&group=learning_levels_reading_nothing',
              $tabsUl = $('#tabs'),
              $contentDiv = $('#content'),
              makeTitle = function (slug) {
                var word, i, words = slug.split('_');
                for(i = 0; i < words.length; i++) {
                  word = words[i];
                  words[i] = word.charAt(0).toUpperCase() + word.slice(1);
                }
                return words.join(' ');
              };

            d3.json(jsonUrl, function(datasets) {

                _.each(datasets, function(dataset, key) { 
                    var $tabPane,
                        dataElement,
                        data,
                        dataSize,
                        dataKey,
                        keyValSeparated,
                        $thisDiv;

                    if(key==="(ALL)") key = "_ALL_"; /* HACK: () don't sit well in anchor tags, apparently */

                    $('<li />').html(
                          $('<a />', {
                              text: key,
                              'data-toggle': 'tab',
                              href: '#' + key
                          })
                        ).appendTo($tabsUl);

                    $tabPane = $('<div />')
                                  .attr('id', key)
                                  .addClass('tab-pane')
                                  .appendTo($contentDiv);

                    for (dataKey in dataset) {
                        dataElement = dataset[dataKey];
                        /* TODO replace using the form schema */
                        dataElement.titleName = makeTitle(dataElement.name);

                        $thisDiv = $('<div />')
                                      .data('target', key)
                                      .appendTo($tabPane);

                        data = dataElement.data;
                        dataSize = _.size(data);
                        if(dataSize == 0 || dataElement.name.charAt(0)=='_') {
                            continue;
                        } else if (dataSize == 1) {
                          $thisDiv.text(dataElement.titleName + " : " + _.values(data)[0] + " responses: " + _.keys(data)[0]);
                        } else { 
                            keyValSeparated = {'x': _.keys(data), 'y': _.values(data)};
                            if (typeof (keyValSeparated.y[0]) === "number") {
                                /* if number make pure histogram */
                                gg.graph(keyValSeparated)
                                      .layer(gg.layer.bar()
                                      .map('x','x').map('y','y'))
                                      .opts({'width':'500', 'height':'400',
                                             'padding-right':'90', 'title':dataElement.titleName,
                                             'legend-postion':'bottom'})
                                      .render($thisDiv.get(0));
                            } 
                        }
                    };
                });
                $('#tabs a:last').tab('show');
            });
          });
        </script>
    </body>
</html>
